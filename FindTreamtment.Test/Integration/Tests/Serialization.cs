/*
* Find Treatment
*/

using FindTreatment.Domain;
using FluentAssertions;
using Microsoft.Extensions.DependencyInjection;
using Newtonsoft.Json;
using Xunit;

namespace FindTreatment.Test.Integration;

[Collection(nameof(IntegrationFixture))]
public class Serialization
{
    private readonly JsonSerializerSettings _settings;

    #region Data

    public const string Data =
        @"{""page"":10,""totalPages"":1208,""recordCount"":2416,""rows"":[{""_irow"":19,""name1"":""Little Colorado"",""name2"":""Behavioral Health Centers"",""street1"":""50 North Hopi Street"",""city"":""Springerville"",""street2"":"""",""state"":""AZ"",""zip"":""85938"",""phone"":""928-333-2683"",""intake1"":null,""hotline1"":null,""website"":""http://"",""latitude"":""34.1340149"",""longitude"":""-109.2817359"",""miles"":1805.9,""services"":[{""f1"":""Type of Care"",""f2"":""TC"",""f3"":""Substance use treatment; Treatment for co-occurring substance use plus either serious mental health illness in adults/serious emotional disturbance in children""},{""f1"":""Service Setting (e.g., Outpatient, Residential, Inpatient, etc.)"",""f2"":""SET"",""f3"":""Outpatient; Intensive outpatient treatment; Outpatient methadone/buprenorphine or naltrexone treatment; Regular outpatient treatment""},{""f1"":""Opioid Medications used in Treatment"",""f2"":""OM"",""f3"":""Buprenorphine used in Treatment; Naltrexone used in Treatment""},{""f1"":""Type of Alcohol Use Disorder Treatment"",""f2"":""AUT"",""f3"":""This facility administers/prescribes medication for alcohol use disorder""},{""f1"":"" External Source of Medications Used for Alcohol Use Disorder Treatment"",""f2"":""SMAT"",""f3"":""No formal relationship with prescribing entity""},{""f1"":""Type of Opioid Treatment"",""f2"":""OT"",""f3"":""Prescribes buprenorphine; Prescribes naltrexone""},{""f1"":""Pharmacotherapies"",""f2"":""PHR"",""f3"":""Disulfiram; Buprenorphine with naloxone; Naltrexone (oral); Clonidine; Medication for mental disorders""},{""f1"":""Treatment Approaches"",""f2"":""TAP"",""f3"":""Brief intervention; Cognitive behavioral therapy; Motivational interviewing; Matrix Model; Relapse prevention; Substance use disorder counseling; Trauma-related counseling; Telemedicine/telehealth therapy""},{""f1"":""Facility Operation (e.g., Private, Public)"",""f2"":""FOP"",""f3"":""Private non-profit organization""},{""f1"":""License/Certification/Accreditation"",""f2"":""LCA"",""f3"":""State department of health""},{""f1"":""Payment/Insurance/Funding Accepted"",""f2"":""PAY"",""f3"":""Medicare; Medicaid; Federal military insurance (e.g., TRICARE); Private health insurance; Cash or self-payment; State-financed health insurance plan other than Medicaid; SAMHSA funding/block grants""},{""f1"":""Payment Assistance Available"",""f2"":""PYAS"",""f3"":""Sliding fee scale (fee is based on income and other factors)""},{""f1"":""Assessment/Pre-treatment"",""f2"":""ASPT"",""f3"":""Comprehensive mental health assessment; Comprehensive substance use assessment; Interim services for clients; Outreach to persons in the community; Screening for tobacco use; Screening for substance use; Screening for mental disorders""},{""f1"":""Testing"",""f2"":""SCR"",""f3"":""Drug or alcohol urine screening; Metabolic syndrome monitoring""},{""f1"":""Transitional Services"",""f2"":""TRSRV"",""f3"":""Aftercare/continuing care; Discharge Planning; Naloxone and overdose education""},{""f1"":""Recovery Support Services"",""f2"":""RSS"",""f3"":""Housing services; Assistance with obtaining social services; Mentoring/peer support; Employment counseling or training""},{""f1"":""Other Services"",""f2"":""OTHR"",""f3"":""Treatment for other addiction disorder""},{""f1"":""Education and Counseling Services"",""f2"":""ECS"",""f3"":""Substance use disorder education; Smoking/vaping/tobacco cessation counseling; Individual counseling; Group counseling; Family counseling; Marital/couples counseling; Vocational training or educational support (for example, high school coursework, GED preparation, etc.) ""},{""f1"":""Facility Smoking Policy "",""f2"":""SMP"",""f3"":""Smoking not permitted""},{""f1"":""Gender Accepted"",""f2"":""GN"",""f3"":""Female; Male""},{""f1"":""Language Services"",""f2"":""SL"",""f3"":""Sign language services for the deaf and hard of hearing""},{""f1"":""Facility Vaping Policy"",""f2"":""FVP"",""f3"":""Vaping not permitted""},{""f1"":""Ancillary Services"",""f2"":""AS"",""f3"":""Case management service; Mental health services; Social skills development; Transportation assistance; Suicide prevention services""}],""typeFacility"":""SA""},{""_irow"":20,""name1"":""Little Colorado"",""name2"":""Behavioral Health Centers"",""street1"":""50 North Hopi Street"",""city"":""Springerville"",""street2"":"""",""state"":""AZ"",""zip"":""85938"",""phone"":""928-333-2683"",""intake1"":null,""hotline1"":null,""website"":""http://"",""latitude"":""34.1340149"",""longitude"":""-109.2817359"",""miles"":1805.9,""services"":[{""f1"":""Type of Care"",""f2"":""TC"",""f3"":""Substance use treatment; Mental health treatment; Treatment for co-occurring substance use plus either serious mental health illness in adults/serious emotional disturbance in children""},{""f1"":""Service Setting (e.g., Outpatient, Residential, Inpatient, etc.)"",""f2"":""SET"",""f3"":""Outpatient""},{""f1"":""Facility Type"",""f2"":""FT"",""f3"":""Outpatient mental health facility""},{""f1"":""Pharmacotherapies"",""f2"":""PHR"",""f3"":""Antipsychotics used in treatment of SMI""},{""f1"":""Treatment Approaches"",""f2"":""TAP"",""f3"":""Cognitive behavioral therapy; Couples/family therapy; Dialectical behavior therapy; Eye Movement Desensitization and Reprocessing therapy; Group therapy; Integrated Mental and Substance Use Disorder treatment; Individual psychotherapy; Telemedicine/telehealth therapy; Abnormal involuntary movement scale""},{""f1"":""Emergency Mental Health Services"",""f2"":""EMS"",""f3"":""Crisis intervention team; Psychiatric emergency walk-in services""},{""f1"":""Facility Operation (e.g., Private, Public)"",""f2"":""FOP"",""f3"":""Private non-profit organization""},{""f1"":""Payment/Insurance/Funding Accepted"",""f2"":""PAY"",""f3"":""County or local government funds; Community Mental Health Block Grants; IHS/Tribal/Urban (ITU) funds; Medicare; Medicaid; Federal military insurance (e.g., TRICARE); Private health insurance; State corrections or juvenile justice funds; State education agency funds; Cash or self-payment; State welfare or child and family services funds; U.S. Department of VA funds""},{""f1"":""Payment Assistance Available"",""f2"":""PYAS"",""f3"":""Sliding fee scale (fee is based on income and other factors)""},{""f1"":""Assessment/Pre-treatment"",""f2"":""ASPT"",""f3"":""Screening for tobacco use""},{""f1"":""Testing"",""f2"":""SCR"",""f3"":""Metabolic syndrome monitoring""},{""f1"":""Recovery Support Services"",""f2"":""RSS"",""f3"":""Housing services; Mentoring/peer support""},{""f1"":""Facility Smoking Policy "",""f2"":""SMP"",""f3"":""Smoking not permitted""},{""f1"":""Age Groups Accepted"",""f2"":""AGE"",""f3"":""Children/Adolescents; Young Adults; Adults; Seniors""},{""f1"":""Language Services"",""f2"":""SL"",""f3"":""Spanish; Sign language services for the deaf and hard of hearing""},{""f1"":""Facility Vaping Policy"",""f2"":""FVP"",""f3"":""Vaping not permitted""},{""f1"":""Ancillary Services"",""f2"":""AS"",""f3"":""Chronic disease/illness management; Court-ordered outpatient treatment; Family psychoeducation; Intensive case management; Psychosocial rehabilitation services; Supported employment; Vocational rehabilitation services; Case management service; Suicide prevention services""}],""typeFacility"":""MH""}]}";

    #endregion

    public Serialization(IntegrationFixture fixture)
    {
        this._settings = fixture.Services.GetRequiredService<JsonSerializerSettings>();
    }

    [Fact]
    public void DeserializationWorks()
    {
        var data = JsonConvert.DeserializeObject<GovPaginatedResponse<GovFacility>>(Data)!;
        data.Page.Should().Be(10);
        data.TotalPages.Should().Be(1208);
        data.RecordCount.Should().Be(2416);
        data.Rows.Should().HaveCount(2);

        data.Rows.SelectMany(z => z.Services).Should().HaveCount(40).And.Subject
            .Should().AllSatisfy(z => z.F2.Should().NotBeNullOrEmpty());
    }
}